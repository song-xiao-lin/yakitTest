const {app, BrowserWindow, dialog, nativeImage, globalShortcut, ipcMain, protocol, Menu} = require("electron")
const isDev = require("electron-is-dev")
const path = require("path")
const url = require("url")
const {registerIPC, registerNewIPC} = require("./ipc")
const process = require("process")
const {
    initExtraLocalCache,
    getExtraLocalCacheValue,
    initLocalCache,
    setCloeseExtraLocalCache,
    setLocalCache
} = require("./localCache")
const {asyncKillDynamicControl} = require("./handlers/dynamicControlFun")
const {windowStatePatch} = require("./filePath")
const Screenshots = require("./screenshots")
const windowStateKeeper = require("electron-window-state")
const {MenuTemplate} = require("./menu")
const {renderLogOutputFile, getAllLogHandles, closeAllLogHandles, initAllLogFolders} = require("./logFile")

/** 获取缓存数据-软件是否需要展示关闭二次确认弹框 */
const UICloseFlag = "windows-close-flag"

/** 窗口对象 */
let win = null
let yakitEngineLinkWin = null

/** 是否展示关闭二次确认弹窗的标志位 */
let closeFlag = true

process.on("uncaughtException", (error) => {
    console.info(error)
})

// 性能优化：https://juejin.cn/post/6844904029231775758

// ======= 全局标志（每个窗口保证只注册一次） =======
let ipcRegistered = false

/**
 * ---------------- 创建 yakitEngineLink 窗口 ----------------
 */
function createYakitEngineLinkWindow(obj) {
    if (yakitEngineLinkWin) {
        yakitEngineLinkWin.setBounds(obj)
        yakitEngineLinkWin.show()
        yakitEngineLinkWin.focus()
        return
    }

    const state = windowStateKeeper({
        defaultWidth: 900,
        defaultHeight: 500,
        path: windowStatePatch,
        file: "yakit-window-state.json"
    })

    yakitEngineLinkWin = new BrowserWindow({
        x: state.x,
        y: state.y,
        width: state.width,
        height: state.height,
        minWidth: 900,
        minHeight: 500,
        frame: false,
        autoHideMenuBar: true,
        webPreferences: {
            preload: path.join(__dirname, "engineLinkPreload.js"),
            nodeIntegration: true,
            contextIsolation: false,
            sandbox: true
        },
        titleBarStyle: "hidden",
        show: true
    })

    state.manage(yakitEngineLinkWin)
    yakitEngineLinkWin.setSize(state.width, state.height)

    if (isDev) yakitEngineLinkWin.loadURL("http://127.0.0.1:5173")
    else yakitEngineLinkWin.loadFile(path.join(__dirname, "../renderer/engine-link-startup/dist/index.html"))

    yakitEngineLinkWin.webContents.setWindowOpenHandler(() => ({action: "deny"}))

    yakitEngineLinkWin.webContents.openDevTools({mode: "detach"})

    yakitEngineLinkWin.setMenu(null)
    yakitEngineLinkWin.setMenuBarVisibility(false)
    if (process.platform === "darwin") yakitEngineLinkWin.setWindowButtonVisibility(false)

    yakitEngineLinkWin.webContents.on("render-process-gone", (event, details) => {
        renderLogOutputFile(`----- YakitEngineLinkWin Render gone ------`)
        renderLogOutputFile(`reason: ${details.reason}, exitCode: ${details.exitCode}`)
        if (details.reason === "crashed") setLocalCache("render-crash-screen", true)
        require("./handlers/logger").saveLogs()
    })

    yakitEngineLinkWin.webContents.on("will-navigate", (e) => e.preventDefault())

    yakitEngineLinkWin.on("close", (e) => {
        e.preventDefault()
        state.saveState(yakitEngineLinkWin)
        yakitEngineLinkWin.webContents.send("close-yakitEngineLinkWin-renderer")
    })

    yakitEngineLinkWin.on("closed", () => {
        yakitEngineLinkWin = null
    })
}

/**
 * ---------------- 创建主窗口 ----------------
 */

function createWindow(obj) {
    if (win) {
        win.setBounds(obj)
        win.show()
        win.focus()
        return
    }

    const state = windowStateKeeper({
        defaultWidth: 900,
        defaultHeight: 500,
        path: windowStatePatch,
        file: "yakit-window-state.json"
    })

    win = new BrowserWindow({
        x: state.x,
        y: state.y,
        width: state.width,
        height: state.height,
        minWidth: 900,
        minHeight: 500,
        frame: false,
        autoHideMenuBar: true,
        webPreferences: {
            preload: path.join(__dirname, "preload.js"),
            nodeIntegration: true,
            contextIsolation: false,
            sandbox: true
        },
        titleBarStyle: "hidden",
        show: false
    })

    state.manage(win)
    win.setSize(state.width, state.height)

    if (isDev) win.loadURL("http://127.0.0.1:3000")
    else win.loadFile(path.resolve(__dirname, "../renderer/pages/main/index.html"))

    if (isDev) win.webContents.openDevTools({mode: "detach"})

    win.setMenu(null)
    win.setMenuBarVisibility(false)
    if (process.platform === "darwin") win.setWindowButtonVisibility(false)

    win.webContents.setWindowOpenHandler(() => ({action: "deny"}))
    win.webContents.on("will-navigate", (e) => e.preventDefault())

    win.webContents.on("render-process-gone", (event, details) => {
        renderLogOutputFile(`----- Render gone ------`)
        renderLogOutputFile(`reason: ${details.reason}, exitCode: ${details.exitCode}`)
        if (details.reason === "crashed") setLocalCache("render-crash-screen", true)
        require("./handlers/logger").saveLogs()
    })

    win.on("close", (e) => {
        e.preventDefault()
        state.saveState(win)
        win.webContents.send("close-windows-renderer")
    })

    win.on("minimize", () => {
        win.webContents.send("refresh-token")
        win.webContents.send("minimize-windows-renderer")
    })

    win.on("maximize", () => {
        win.webContents.send("refresh-token")
    })

    win.on("closed", () => {
        win = null
    })
}

function safeSend(targetWin, channel, data) {
    if (!targetWin || targetWin.isDestroyed()) return

    const sendFn = () => {
        try {
            targetWin.webContents.send(channel, data)
        } catch (e) {
            console.warn(`[safeSend] send failed: ${channel}`, e)
        }
    }

    if (targetWin.webContents.isLoading()) {
        targetWin.webContents.once("did-finish-load", sendFn)
    } else {
        sendFn()
    }
}

/**
 * ---------------- 注册 IPC，只执行一次 ----------------
 */
function registerGlobalIPC() {
    if (ipcRegistered) return
    ipcRegistered = true

    // ------------------- 主题相关 -------------------
    // 设置主题
    ipcMain.handle("set-theme", (_e, theme) => {
        ;[
            // 通知所有窗口更新
            yakitEngineLinkWin
        ].forEach((w) => safeSend(w, "theme-updated", theme))
    })

    // ------------------- 窗口完成操作 -------------------
    // yakitEngineLink 完成操作
    ipcMain.handle("yakitEngineLinkWin-done", async (event, data) => {
        const [x, y] = yakitEngineLinkWin.getPosition()
        const [width, height] = yakitEngineLinkWin.getSize()
        yakitEngineLinkWin.hide()
        createWindow({x, y, width, height})
        safeSend(win, "from-yakitEngineLinkWin", data)
    })

    // win 完成操作
    ipcMain.handle("yakitMainWin-done", async (event, data) => {
        const [x, y] = win.getPosition()
        const [width, height] = win.getSize()
        win.hide()
        createYakitEngineLinkWindow({x, y, width, height})
        safeSend(yakitEngineLinkWin, "from-win", data)
    })

    // 软件退出逻辑
    ipcMain.handle("app-exit", async (e, params) => {
        const {isYakitEngineLinkWin, showCloseMessageBox, isIRify} = params
        const parentWindow = isYakitEngineLinkWin ? yakitEngineLinkWin : win

        const exitCleanupOperation = () => {
            if (yakitEngineLinkWin) {
                yakitEngineLinkWin.close()
                yakitEngineLinkWin = null
            }
            if (win) {
                win.close()
                win = null
            }
            closeAllLogHandles()
            app.exit()
        }

        if (closeFlag && showCloseMessageBox && parentWindow) {
            dialog
                .showMessageBox(parentWindow, {
                    icon: nativeImage.createFromPath(
                        path.join(
                            __dirname,
                            isIRify ? "../renderer/src/main/src/assets/yakitSS.png" : "../assets/yakitlogo.pic.jpg"
                        )
                    ),
                    type: "none",
                    title: "提示",
                    defaultId: 0,
                    cancelId: 3,
                    message: "确定要关闭吗？",
                    buttons: ["最小化", "直接退出"],
                    checkboxLabel: "不再展示关闭二次确认？",
                    checkboxChecked: false,
                    noLink: true
                })
                .then(async (res) => {
                    await setCloeseExtraLocalCache(UICloseFlag, !res.checkboxChecked)
                    await asyncKillDynamicControl()
                    if (res.response === 0) {
                        e.preventDefault()
                        yakitEngineLinkWin?.minimize()
                        win?.minimize()
                    } else if (res.response === 1) {
                        exitCleanupOperation()
                    } else {
                        e.preventDefault()
                    }
                })
        } else {
            await asyncKillDynamicControl()
            exitCleanupOperation()
        }
    })

    try {
        registerIPC(win)
        registerNewIPC(yakitEngineLinkWin, "EngineLink:")
        console.log("[Main] registerIPC(win) completed")
    } catch (err) {
        console.error("[Main] registerIPC(win) error:", err)
    }
}

/**
 * set software menu
 */
const menu = Menu.buildFromTemplate(MenuTemplate)
Menu.setApplicationMenu(menu)

/**
 * ---------------- App Ready ----------------
 */
app.whenReady().then(() => {
    /**
     * init-log-folders:
     * 存在则检查文件数量是否超过10个，超过则只保留最近10个文件
     * 不存在则新建文件夹
     */
    initAllLogFolders()

    /** 获取缓存数据并储存于软件内 */
    initLocalCache()
    /** 获取扩展缓存数据并储存于软件内(是否弹出关闭二次确认弹窗) */
    initExtraLocalCache(() => {
        const cacheFlag = getExtraLocalCacheValue(UICloseFlag)
        closeFlag = cacheFlag === undefined ? true : cacheFlag
    })

    // 截图功能注册
    if (["darwin", "win32"].includes(process.platform)) {
        const screenshots = new Screenshots({singleWindow: true})
        ipcMain.handle("activate-screenshot", () => {
            screenshots.startCapture()
            globalShortcut.register("esc", () => {
                screenshots.endCapture()
                globalShortcut.unregister("esc")
            })
        })
        globalShortcut.register("Control+Shift+q", () => {
            screenshots.endCapture()
            globalShortcut.unregister("esc")
        })
        screenshots.on("ok", () => {
            if (screenshots.$win?.isFocused()) {
                screenshots.endCapture()
                globalShortcut.unregister("esc")
            }
        })
        screenshots.on("cancel", () => {
            globalShortcut.unregister("esc")
        })
    }

    // 注册协议
    protocol.registerFileProtocol("atom", (request, callback) => {
        const filePath = url.fileURLToPath("file://" + request.url.slice("atom://".length))
        callback(filePath)
    })

    try {
        getAllLogHandles()
    } catch (error) {}

    createYakitEngineLinkWindow({})
    createWindow({})

    app.on("activate", function () {
        if (BrowserWindow.getAllWindows().length === 0) createYakitEngineLinkWindow({})
    })

    // IPC
    try {
        registerGlobalIPC()
    } catch (error) {}
})

/**
 * ---------------- 全局退出逻辑 ----------------
 */
// 这个退出压根执行不到 win.on("close") 阻止了默认行为
app.on("window-all-closed", () => {
    app.quit()
})
